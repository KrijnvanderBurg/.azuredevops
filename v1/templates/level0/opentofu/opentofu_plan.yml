# Requirements:
# - OpenTofu is installed on pipeline agent
# - opentofu init

parameters:
- name: enabled
  type: boolean
  default: true

- name: continueOnError
  type: boolean
  default: false

- name: openTofuDir
  type: string

- name: openTofuPlanFilepath
  type: string

- name: artifactName
  type: string
  default: opentofu

steps:
- task: AzureCLI@2
  displayName: OpenTofu plan
  inputs:
    azureSubscription: pers-reg-dev-eu-krijn
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      echo "pwd: $(pwd)"
      echo "ls: $(ls)"
      echo "Build.ArtifactStagingDirectory: $BUILD_ARTIFACTSTAGINGDIRECTORY"
      echo "Build.Repository.LocalPath: $BUILD_REPOSITORY_LOCALPATH"
      echo "Build.StagingDirectory: $BUILD_STAGINGDIRECTORY"
      echo "System.DefaultWorkingDirectory: $SYSTEM_DEFAULTWORKINGDIRECTORY"
      echo "System.ArtifactsDirectory: $SYSTEM_ARTIFACTSDIRECTORY"
      tofu plan -out=${{ parameters.openTofuPlanFilepath }}
    workingDirectory: ${{ parameters.openTofuDir }}
  env:
    TF_LOG: INFO

- publish: ${{ parameters.openTofuPlanFilepath }}
  artifact: ${{ parameters.artifactName }}
